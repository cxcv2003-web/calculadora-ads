<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Presupuesto Meta Ads</title>
    
    <!-- Tailwind CSS CDN --><script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsPDF CDN (para generar PDF) --><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Lucide Icons CDN (para iconos) --><script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Fuente Inter (similar a la de Meta) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #151415; /* Fondo general */
            color: #EEF0F2; /* Texto general */
        }

        /* Estilos para los inputs */
        input[type="number"] {
            background-color: #2a292a;
            border: 1px solid #4a4a4a;
            color: #EEF0F2;
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.75rem 1rem; /* py-3 px-4 */
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        input[type="number"]:focus {
            outline: none;
            border-color: #FAE104;
            box-shadow: 0 0 0 2px rgba(250, 225, 4, 0.5);
        }

        /* Ocultar flechas en inputs numéricos */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* --- ESTILOS DE BOTONES FINALES --- */

        /* Estilo de Pestañas (ahora botones de formulario) */
        .tab-btn {
            /* Estilo de botón sólido */
            @apply w-full font-bold text-base transition-all duration-300 py-3 px-4 rounded-lg text-center shadow-lg border;
        }
        .tab-active-custom {
            /* Botón de campaña activo (fondo amarillo, texto oscuro) */
            @apply bg-[#FAE104] text-[#151415] border-[#FAE104]; 
        }
        .tab-inactive-custom {
            /* Botón de campaña inactivo (fondo gris) + hover (amarillo 50%) */
            @apply text-gray-300 bg-[#2a292a] border-white/20 hover:text-white hover:bg-[#FAE104]/[0.5] hover:border-[#FAE104];
        }

        /* Estilo del Botón Principal (restaurado al original con ícono y gap-2) */
        .calc-btn {
            @apply w-full col-span-1 md:col-span-2 bg-[#FAE104] text-[#151415] font-bold py-3 px-6 rounded-lg text-lg transition-transform duration-200 ease-in-out shadow-lg; /* RESTAURADO */
        }
        .calc-btn:hover {
            @apply bg-yellow-300 transform scale-105 shadow-xl; /* RESTAURADO */
        }
        
        /* Estilo del Botón PDF (sin cambios) */
        .pdf-btn {
             @apply w-full max-w-xs mx-auto mt-8 flex items-center justify-center gap-2 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition-transform duration-200 ease-in-out;
        }
        .pdf-btn:hover {
            @apply bg-blue-500 transform scale-105 shadow-lg;
        }
    </style>
</head>
<body class="min-h-screen w-full flex items-center justify-center p-4">

    <main class="w-full max-w-3xl mx-auto bg-[#1E1D1E] rounded-2xl shadow-2xl overflow-hidden">
        
        <!-- Contenedor de Pestañas y Formulario --><div class="p-6 sm:p-10">
            <!-- Título Original Restaurado --><h1 class="text-3xl sm:text-4xl font-black text-center text-[#FAE104] mb-8">
                CALCULADORA DE PRESUPUESTO<br>PARA META ADS
            </h1>

            <!-- Formulario de Inputs --><form id="calc-form" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                
                <!-- Botones de Campaña (Movidos aquí, sin íconos) --><button type="button" id="tab-messages" class="tab-btn tab-active-custom">
                    Campaña de Mensajes
                </button>
                
                <!-- Botón Inactivo (Estilos finales aplicados desde CSS) -->
                <button type="button" id="tab-ecommerce" class="tab-btn tab-inactive-custom">
                    Campaña de Ventas
                </button>
                <!-- **** FIN DE LA PRUEBA **** -->


                <!-- Campos del Formulario --><div>
                    <label for="objetivo_ingreso" class="block text-sm font-medium mb-2">Objetivo de Ingreso Mensual (USD)</label>
                    <input type="number" id="objetivo_ingreso" step="0.01" min="0" required placeholder="Ej: 5000.00">
                </div>
                
                <div>
                    <label for="ticket_promedio" class="block text-sm font-medium mb-2">Ticket Promedio (USD)</label>
                    <input type="number" id="ticket_promedio" step="0.01" min="0" required placeholder="Ej: 150.00">
                </div>

                <div>
                    <label for="margen_beneficio" class="block text-sm font-medium mb-2">Margen de Beneficio (%)</label>
                    <input type="number" id="margen_beneficio" step="0.01" min="0" max="100" required placeholder="Ej: 30">
                </div>

                <div>
                    <label id="label-tasa" for="tasa_conversion" class="block text-sm font-medium mb-2">Tasa de Cierre (%)</label>
                    <input type="number" id="tasa_conversion" step="0.01" min="0" max="100" required placeholder="Ej: 10">
                </div>

                <div>
                    <label for="porcentaje_publicidad" class="block text-sm font-medium mb-2">Porcentaje Asignado a Publicidad (%)</label>
                    <input type="number" id="porcentaje_publicidad" step="0.01" min="0" max="100" required placeholder="Ej: 20">
                </div>

                <div>
                    <label for="duracion_campana" class="block text-sm font-medium mb-2">Duración de la Campaña (Días)</label>
                    <input type="number" id="duracion_campana" step="1" min="1" required placeholder="Ej: 30">
                </div>

                <!-- Botón de Calcular (Restaurado a su estilo original) --><button type="submit" class="calc-btn mt-6">
                    <span class="flex items-center justify-center gap-2">
                        <i data-lucide="calculator"></i>
                        Calcular
                    </span>
                </button>
            </form>
        </div>

        <!-- Sección de Resultados (Oculta por defecto) --><section id="results-section" class="hidden bg-[#151415] p-6 sm:p-10">
            
            <!-- Métricas Clave --><div>
                <h2 class="text-2xl font-bold text-center text-[#DA2677] mb-6">Métricas Clave</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-5 text-center">
                    
                    <div class="bg-[#1E1D1E] p-4 rounded-lg">
                        <span id="label-vn" class="block text-sm text-gray-400">Ventas Necesarias</span>
                        <span id="result-vn" class="block text-2xl font-bold text-white">0</span>
                    </div>

                    <div class="bg-[#1E1D1E] p-4 rounded-lg">
                        <span id="label-cn" class="block text-sm text-gray-400">Conversaciones Necesarias</span>
                        <span id="result-cn" class="block text-2xl font-bold text-white">0</span>
                    </div>

                    <div class="bg-[#1E1D1E] p-4 rounded-lg">
                        <span id="label-cpa" class="block text-sm text-gray-400">CPA Máximo Recomendado</span>
                        <span id="result-cpa" class="block text-2xl font-bold text-white">$0.00</span>
                    </div>

                    <div class="bg-[#1E1D1E] p-4 rounded-lg">
                        <span id="label-cac" class="block text-sm text-gray-400">CAC Máximo</span>
                        <span id="result-cac" class="block text-2xl font-bold text-white">$0.00</span>
                    </div>
                </div>
            </div>

            <!-- Presupuesto Recomendado --><div class="mt-10 pt-8 border-t border-gray-700">
                <h2 class="text-2xl font-bold text-center text-[#FAE104] mb-4">Presupuesto Publicitario</h2>
                
                <div class="text-center bg-[#1E1D1E] p-6 rounded-lg shadow-lg">
                    <span class="block text-lg text-gray-300">Presupuesto Mensual Recomendado</span>
                    <span id="result-pm" class="block text-6xl font-black text-[#17A34B] my-2">$0.00</span>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-5 text-center mt-5">
                    <div class="bg-[#1E1D1E] p-4 rounded-lg">
                        <span class="block text-sm text-gray-400">Presupuesto Diario Mínimo</span>
                        <span id="result-pdm" class="block text-3xl font-bold text-white">$0.00</span>
                    </div>
                    <div class="bg-[#1E1D1E] p-4 rounded-lg">
                        <span class="block text-sm text-gray-400">ROAS Mínimo Necesario</span>
                        <span id="result-roas" class="block text-3xl font-bold text-white">0.00x</span>
                    </div>
                </div>
            </div>

            <!-- Análisis IA --><div class="mt-10 pt-8 border-t border-gray-700">
                <h2 class="text-2xl font-bold text-center text-white mb-6">Análisis del Experto (IA)</h2>
                
                <!-- Loading Spinner --><div id="ai-loading" class="hidden flex justify-center items-center h-24">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#FAE104]"></div>
                </div>

                <!-- Resultado IA --><div id="ai-result" class="bg-[#1E1D1E] p-5 rounded-lg text-gray-300 italic prose prose-invert max-w-none">
                    <p>Esperando análisis de la IA...</p>
                </div>
            </div>

            <!-- Botón de Descarga PDF --><button id="download-pdf" class="pdf-btn">
                <i data-lucide="download"></i>
                Descargar Reporte PDF
            </button>
        </section>
    </main>

    <script>
        // Inicializar Lucide Icons
        lucide.createIcons();

        // --- REFERENCIAS AL DOM ---
        const tabMessages = document.getElementById('tab-messages');
        const tabEcommerce = document.getElementById('tab-ecommerce');
        const calcForm = document.getElementById('calc-form');
        const resultsSection = document.getElementById('results-section');
        
        // Inputs
        const inputs = {
            objetivo_ingreso: document.getElementById('objetivo_ingreso'),
            ticket_promedio: document.getElementById('ticket_promedio'),
            margen_beneficio: document.getElementById('margen_beneficio'),
            tasa_conversion: document.getElementById('tasa_conversion'),
            porcentaje_publicidad: document.getElementById('porcentaje_publicidad'),
            duracion_campana: document.getElementById('duracion_campana'),
        };

        // Labels dinámicos
        const labelTasa = document.getElementById('label-tasa');
        const labelVn = document.getElementById('label-vn');
        const labelCn = document.getElementById('label-cn');
        const labelCpa = document.getElementById('label-cpa');
        const labelCac = document = document.getElementById('label-cac');

        // Resultados
        const results = {
            vn: document.getElementById('result-vn'),
            cn: document.getElementById('result-cn'),
            cpa: document.getElementById('result-cpa'),
            cac: document.getElementById('result-cac'),
            pm: document.getElementById('result-pm'),
            pdm: document.getElementById('result-pdm'),
            roas: document.getElementById('result-roas'),
        };

        // AI
        const aiLoading = document.getElementById('ai-loading');
        const aiResult = document.getElementById('ai-result');

        // PDF
        const downloadPdfBtn = document.getElementById('download-pdf');

        // --- ESTADO DE LA APLICACIÓN ---
        let currentTab = 'messages'; // 'messages' o 'ecommerce'
        let lastInputs = {};
        let lastResults = {};
        let currentLabels = {};

        // --- LÓGICA DE PESTAÑAS ---
        function switchTab(tabName) {
            currentTab = tabName;
            
            if (tabName === 'messages') {
                // Activar Pestaña Mensajes
                tabMessages.classList.add('tab-active-custom');
                tabMessages.classList.remove('tab-inactive-custom');
                tabEcommerce.classList.add('tab-inactive-custom');
                tabEcommerce.classList.remove('tab-active-custom');
                
                // Actualizar labels del formulario
                labelTasa.textContent = 'Tasa de Cierre (%)';
                inputs.tasa_conversion.placeholder = "Ej: 10";

                // Actualizar labels de resultados
                currentLabels = {
                    tasa: 'Tasa de Cierre',
                    vn: 'Ventas Necesarias',
                    cn: 'Conversaciones Necesarias',
                    cpa: 'CPA Máximo Recomendado',
                    cac: 'CAC Máximo (Costo por Conversación)',
                };
                
            } else if (tabName === 'ecommerce') {
                // Activar Pestaña E-commerce
                tabEcommerce.classList.add('tab-active-custom');
                tabEcommerce.classList.remove('tab-inactive-custom');
                tabMessages.classList.add('tab-inactive-custom');
                tabMessages.classList.remove('tab-active-custom');

                // Actualizar labels del formulario
                labelTasa.textContent = 'Tasa de Conversión de la Tienda (%)';
                inputs.tasa_conversion.placeholder = "Ej: 1.5";
                
                // Actualizar labels de resultados
                currentLabels = {
                    tasa: 'Tasa de Conversión',
                    vn: 'Órdenes Necesarias',
                    cn: 'Tráfico Necesario (Clics)',
                    cpa: 'CMV Recomendado (Costo por Venta)',
                    cac: 'CPC Máximo (Costo por Clic)',
                };
            }
            
            // Actualizar labels visibles en la UI de resultados
            labelVn.textContent = currentLabels.vn;
            labelCn.textContent = currentLabels.cn;
            labelCpa.textContent = currentLabels.cpa;
            labelCac.textContent = currentLabels.cac;
        }

        tabMessages.addEventListener('click', () => switchTab('messages'));
        tabEcommerce.addEventListener('click', () => switchTab('ecommerce'));

        // --- LOCALSTORAGE ---
        function saveToLocalStorage() {
            const currentInputs = {
                objetivo_ingreso: inputs.objetivo_ingreso.value,
                ticket_promedio: inputs.ticket_promedio.value,
                margen_beneficio: inputs.margen_beneficio.value,
                tasa_conversion: inputs.tasa_conversion.value,
                porcentaje_publicidad: inputs.porcentaje_publicidad.value,
                duracion_campana: inputs.duracion_campana.value,
                lastTab: currentTab // Guardar también la última pestaña
            };
            localStorage.setItem('metaCalcInputs', JSON.stringify(currentInputs));
            lastInputs = currentInputs; // Guardar para el PDF
        }

        function loadFromLocalStorage() {
            const savedInputs = localStorage.getItem('metaCalcInputs');
            if (savedInputs) {
                const parsedInputs = JSON.parse(savedInputs);
                inputs.objetivo_ingreso.value = parsedInputs.objetivo_ingreso || '';
                inputs.ticket_promedio.value = parsedInputs.ticket_promedio || '';
                inputs.margen_beneficio.value = parsedInputs.margen_beneficio || '';
                inputs.tasa_conversion.value = parsedInputs.tasa_conversion || '';
                inputs.porcentaje_publicidad.value = parsedInputs.porcentaje_publicidad || '';
                inputs.duracion_campana.value = parsedInputs.duracion_campana || '';
                
                // Cargar y activar la última pestaña
                const lastTab = parsedInputs.lastTab || 'messages';
                switchTab(lastTab);
            } else {
                // Si no hay nada guardado, inicializar los labels
                switchTab('messages');
            }
        }

        // Cargar al inicio
        document.addEventListener('DOMContentLoaded', loadFromLocalStorage);

        // --- LÓGICA DE CÁLCULO ---
        calcForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // 1. Guardar en LocalStorage
            saveToLocalStorage();

            // 2. Obtener valores y parsear
            const I = parseFloat(inputs.objetivo_ingreso.value);
            const T = parseFloat(inputs.ticket_promedio.value);
            const M = parseFloat(inputs.margen_beneficio.value) / 100;
            const C = parseFloat(inputs.tasa_conversion.value) / 100;
            const A = parseFloat(inputs.porcentaje_publicidad.value) / 100;
            const D = parseInt(inputs.duracion_campana.value);

            // 3. Validar
            if (isNaN(I) || isNaN(T) || isNaN(M) || isNaN(C) || isNaN(A) || isNaN(D) || T === 0 || C === 0 || D === 0) {
                alert("Por favor, rellena todos los campos con valores válidos y mayores a cero donde corresponda.");
                return;
            }

            // 4. Realizar Cálculos
            const VN_ONN = I / T;
            const CN_TTN = VN_ONN / C;
            const CPA_CMV = T * M * A;
            const CAC_CPC = CPA_CMV * C;
            const PM = CAC_CPC * CN_TTN;
            const PDM = PM / D;
            const ROAS = I / PM;

            // Guardar resultados para el PDF y IA
            lastResults = { VN_ONN, CN_TTN, CPA_CMV, CAC_CPC, PM, PDM, ROAS };

            // 5. Mostrar Resultados (Formateados)
            results.vn.textContent = formatNumber(VN_ONN, 0);
            results.cn.textContent = formatNumber(CN_TTN, 0);
            results.cpa.textContent = formatCurrency(CPA_CMV);
            results.cac.textContent = formatCurrency(CAC_CPC);
            
            results.pm.textContent = formatCurrency(PM);
            results.pdm.textContent = formatCurrency(PDM);
            results.roas.textContent = `${formatNumber(ROAS, 2)}x`;

            // 6. Mostrar sección de resultados
            resultsSection.classList.remove('hidden');
            
            // 7. Desplazarse a los resultados
            resultsSection.scrollIntoView({ behavior: 'smooth' });

            // 8. Iniciar análisis IA
            getAIAnalysis();
        });

        // --- LÓGICA DE IA (GEMINI) ---
        async function getAIAnalysis() {
            aiLoading.classList.remove('hidden');
            aiLoading.classList.add('flex');
            aiResult.classList.add('hidden');
            aiResult.innerHTML = '';

            // Construir el prompt para la IA
            const systemPrompt = `Eres "Budget Master", un experto de clase mundial en campañas de Meta Ads (Facebook e Instagram) y estratega de marketing digital. Tu tono es profesional, directo y analítico.
Tu tarea es analizar los datos y resultados de la calculadora de presupuesto que te proporcionará el usuario.
Debes proporcionar un análisis conciso (máximo 3 párrafos cortos) sobre la viabilidad de los números.
Enfócate en los puntos críticos:
1.  Analiza el Costo por Adquisición (CPA/CMV) y el Costo por Conversión (CAC/CPC). ¿Son realistas para el ticket promedio?
2.  Analiza el ROAS Mínimo Necesario. ¿Es un ROAS alcanzable o es demasiado exigente?
3.  Menciona el principal desafío u oportunidad basándote en la Tasa de Cierre/Conversión proporcionada.
4.  Termina con una recomendación clave.
Utiliza formato Markdown simple (negritas y listas) para estructurar tu respuesta.`;

            const userPrompt = `Hola Budget Master, por favor analiza mi escenario:

**Datos de Entrada:**
* **Tipo de Campaña:** ${currentTab === 'messages' ? 'Mensajes (WhatsApp)' : 'Ventas (E-Commerce)'}
* **Objetivo de Ingreso:** ${formatCurrency(lastInputs.objetivo_ingreso)}
* **Ticket Promedio:** ${formatCurrency(lastInputs.ticket_promedio)}
* **${currentLabels.tasa}:** ${lastInputs.tasa_conversion}%
* **Margen de Beneficio:** ${lastInputs.margen_beneficio}%
* **% Asignado a Publicidad (del margen):** ${lastInputs.porcentaje_publicidad}%

**Resultados Clave Calculados:**
* **${currentLabels.cpa}:** ${formatCurrency(lastResults.CPA_CMV)}
* **${currentLabels.cac}:** ${formatCurrency(lastResults.CAC_CPC)}
* **${currentLabels.vn} (mensual):** ${formatNumber(lastResults.VN_ONN, 0)}
* **${currentLabels.cn} (mensual):** ${formatNumber(lastResults.CN_TTN, 0)}
* **Presupuesto Mensual:** ${formatCurrency(lastResults.PM)}
* **Presupuesto Diario:** ${formatCurrency(lastResults.PDM)}
* **ROAS Mínimo Necesario:** ${formatNumber(lastResults.ROAS, 2)}x

Dame tu análisis experto.`;

            // Clave API (se deja vacía según instrucciones)
            // const apiKey = "";  <- ELIMINADO
            
            // MODIFICADO: Ahora llamamos a NUESTRA función de Netlify
            const apiUrl = "/.netlify/functions/getAIAnalysis";

            // MODIFICADO: El payload que enviamos a NUESTRO backend
            const payload = {
                systemPrompt: systemPrompt,
                userPrompt: userPrompt
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload) // Enviamos los prompts a nuestra función
                });

                if (!response.ok) {
                    // Si nuestra función falla, mostrará el error
                    const errorResult = await response.json();
                    throw new Error(errorResult.error || `Error del servidor: ${response.statusText}`);
                }

                const result = await response.json();
                
                // MODIFICADO: Leemos la propiedad "text" que devuelve nuestra función
                if (result.text) {
                    const text = result.text;
                    // Reemplazar saltos de línea de Markdown con HTML
                    const formattedText = text
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Negrita
                        .replace(/\*(.*?)\*/g, '<em>$1</em>') // Cursiva
                        .replace(/^- (.*$)/gm, '<ul class="list-disc pl-5"><li>$1</li></ul>') // Listas (simple)
                        .replace(/\n/g, '<br>'); // Saltos de línea
                    
                    aiResult.innerHTML = formattedText;
                } else {
                    throw new Error("Respuesta de la IA inválida (respuesta vacía).");
                }

            } catch (error) {
                console.error("Error al contactar la IA:", error);
                aiResult.innerHTML = `<p class="text-red-400">Error al obtener el análisis de la IA. Por favor, inténtalo de nuevo más tarde.<br>${error.message}</p>`;
            } finally {
                aiLoading.classList.add('hidden');
                aiLoading.classList.remove('flex');
                aiResult.classList.remove('hidden');
            }
        }

        // --- LÓGICA DE PDF ---
        downloadPdfBtn.addEventListener('click', () => {
            // Asegurarse de que las librerías estén cargadas
            if (typeof window.jspdf === 'undefined') {
                alert("Error: La librería PDF no se ha cargado. Por favor, recarga la página.");
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4'); // 'p'ortrait, 'p'oin't's, 'a4'
            
            let y = 60; // Posición Y inicial

            // *** CORRECCIÓN ***
            // Definir márgenes y constantes de página aquí
            const pageHeight = doc.internal.pageSize.getHeight();
            const leftMargin = 40;
            const rightMargin = 40;
            const topMargin = 60;
            const bottomMargin = 60;
            const textWidth = doc.internal.pageSize.getWidth() - leftMargin - rightMargin;

            // --- TÍTULO ---
            doc.setFont('Inter', 'bold');
            doc.setFontSize(22);
            doc.setTextColor('#151415'); // Texto oscuro
            doc.text("Reporte de Presupuesto - Meta Ads", doc.internal.pageSize.getWidth() / 2, y, { align: 'center' });
            y += 40;

            // --- SECCIÓN: DATOS INGRESADOS ---
            y = addSectionTitle(doc, y, "Datos Ingresados");
            y = addKeyValue(doc, y, "Tipo de Campaña:", currentTab === 'messages' ? 'Mensajes (WhatsApp)' : 'Ventas (E-Commerce)');
            y = addKeyValue(doc, y, "Objetivo de Ingreso:", formatCurrency(lastInputs.objetivo_ingreso));
            y = addKeyValue(doc, y, "Ticket Promedio:", formatCurrency(lastInputs.ticket_promedio));
            y = addKeyValue(doc, y, "Margen de Beneficio:", `${lastInputs.margen_beneficio}%`);
            y = addKeyValue(doc, y, currentLabels.tasa + ":", `${lastInputs.tasa_conversion}%`);
            y = addKeyValue(doc, y, "% Asignado a Publicidad:", `${lastInputs.porcentaje_publicidad}%`);
            y = addKeyValue(doc, y, "Duración de Campaña:", `${lastInputs.duracion_campana} días`);
            y += 20;

            // --- SECCIÓN: MÉTRICAS CLAVE ---
            y = addSectionTitle(doc, y, "Métricas Clave", "#DA2677");
            y = addKeyValue(doc, y, currentLabels.vn + ":", formatNumber(lastResults.VN_ONN, 0));
            y = addKeyValue(doc, y, currentLabels.cn + ":", formatNumber(lastResults.CN_TTN, 0));
            y = addKeyValue(doc, y, currentLabels.cpa + ":", formatCurrency(lastResults.CPA_CMV));
            y = addKeyValue(doc, y, currentLabels.cac + ":", formatCurrency(lastResults.CAC_CPC));
            y += 20;

            // --- SECCIÓN: PRESUPUESTO RECOMENDADO ---
            y = addSectionTitle(doc, y, "Presupuesto Publicitario Recomendado", "#FAE104");
            
            // Destacado
            doc.setFont('Inter', 'bold');
            doc.setFontSize(28);
            doc.setTextColor('#17A34B'); // Verde
            doc.text(formatCurrency(lastResults.PM), doc.internal.pageSize.getWidth() / 2, y + 25, { align: 'center' });
            doc.setFontSize(11);
            doc.setTextColor('#333333');
            doc.text("Presupuesto Mensual", doc.internal.pageSize.getWidth() / 2, y + 45, { align: 'center' });
            y += 80;

            // Otros presupuestos
            y = addKeyValue(doc, y, "Presupuesto Diario Mínimo:", formatCurrency(lastResults.PDM));
            y = addKeyValue(doc, y, "ROAS Mínimo Necesario:", `${formatNumber(lastResults.ROAS, 2)}x`);
            y += 20;

            // --- SECCIÓN: ANÁLISIS IA ---
            const aiText = aiResult.innerText; // Tomar el texto plano del resultado
            if (aiText && !aiText.startsWith("Error")) {
                y = addSectionTitle(doc, y, "Análisis del Experto (IA)");
                doc.setFont('Inter', 'normal');
                doc.setFontSize(10);
                doc.setTextColor('#333333');
                
                // *** CORRECCIÓN ***
                // Quitar definiciones de márgenes de aquí
                const lineHeight = 12; // Basado en font size 10

                // Dividir el texto en líneas
                const splitText = doc.splitTextToSize(aiText, textWidth);

                // Iterar sobre cada línea y dibujarla, añadiendo página si es necesario
                for (const line of splitText) {
                    // Comprobar si la línea actual excede el margen inferior
                    if (y + lineHeight > pageHeight - bottomMargin) {
                        doc.addPage();
                        y = topMargin; // Reiniciar 'y' al margen superior en la nueva página
                    }
                    doc.text(line, leftMargin, y);
                    y += lineHeight; // Mover 'y' hacia abajo para la siguiente línea
                }
                
                y += 20; // Espacio después del análisis
            }

            // --- SECCIÓN: CALL TO ACTION (CTA) ---
            // Asegurarse de que el CTA quepa, si no, agregar nueva página
            // Altura estimada del CTA (título + 3 líneas de contacto + espaciado)
            const ctaBlockHeight = 40 + 20 + 20 + (18 * 3) + 60; // Aprox 194
            
            // *** CORRECCIÓN ***
            // Usar variables de márgenes definidas arriba
            if (y + ctaBlockHeight > pageHeight - bottomMargin) {
                doc.addPage();
                y = topMargin; // Reiniciar 'y' al margen superior
            }
            
            // Fondo amarillo para el CTA
            doc.setFillColor('#FAE104');
            doc.rect(40, y, doc.internal.pageSize.getWidth() - 80, 40, 'F');
            
            doc.setFont('Inter', 'bold');
            doc.setFontSize(16);
            doc.setTextColor('#151415');
            doc.text("¡Empecemos juntos a lanzar tus campañas!", doc.internal.pageSize.getWidth() / 2, y + 26, { align: 'center' });
            y += 60;

            // Datos de contacto
            doc.setFont('Inter', 'normal');
            doc.setFontSize(12);
            doc.setTextColor('#333333');
            doc.text("Contacto:", 40, y);
            y += 20;
            
            doc.setFont('Inter', 'bold');
            doc.text("WhatsApp:", 60, y);
            doc.setFont('Inter', 'normal');
            doc.text("+593 96 274 1771", 140, y);
            y += 18;

            doc.setFont('Inter', 'bold');
            doc.text("Instagram:", 60, y);
            doc.setFont('Inter', 'normal');
            doc.text("@reivera.studio", 140, y);
            y += 18;
            
            doc.setFont('Inter', 'bold');
            doc.text("Correo:", 60, y);
            doc.setFont('Inter', 'normal');
            doc.text("rei.vera@outlook.com", 140, y);
            
            // --- GUARDAR PDF ---
            doc.save('Reporte_Presupuesto_Meta_Ads.pdf');
        });

        // --- FUNCIONES AUXILIARES PDF ---
        function addSectionTitle(doc, y, title, color = '#151415') {
            doc.setFont('Inter', 'bold');
            doc.setFontSize(16);
            doc.setTextColor(color);
            doc.text(title, 40, y);
            doc.setLineWidth(1.5);
            doc.setDrawColor(color);
            doc.line(40, y + 8, doc.internal.pageSize.getWidth() - 40, y + 8);
            return y + 35;
        }

        function addKeyValue(doc, y, key, value) {
            doc.setFont('Inter', 'bold');
            doc.setFontSize(11);
            doc.setTextColor('#555555');
            doc.text(key, 50, y);
            
            doc.setFont('Inter', 'normal');
            doc.setTextColor('#151415');
            doc.text(value, 240, y);
            return y + 20;
        }


        // --- FUNCIONES AUXILIARES DE FORMATO ---
        function formatCurrency(num) {
            if (isNaN(num)) return "$0.00";
            return num.toLocaleString('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function formatNumber(num, digits) {
            if (isNaN(num)) return "0";
            return num.toLocaleString('en-US', {
                minimumFractionDigits: digits,
                maximumFractionDigits: digits
            });
        }
    </script>

</body>
</html>

